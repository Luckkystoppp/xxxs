<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Shop TXT</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="sidebar">
    <div class="logo">SERVER KEY</div>
    <div class="nav-items">
      <a href="/dashboard" class="nav-item"><span>üìä</span> Dashboard</a>
      <a href="/shop" class="nav-item active"><span>üõí</span> Shop TXT</a>
      <a href="/hotmail" class="nav-item"><span>üìß</span> Hotmail</a>
      <a href="/ulp" class="nav-item"><span>üîç</span> ULP</a>
      <a href="/bin" class="nav-item"><span>üí≥</span> BIN</a>
      <a href="/settings" class="nav-item" id="sets" style="display:none"><span>‚öôÔ∏è</span> Settings</a>
    </div>
  </div>

  <div class="header">
    <div class="header-title">Shop TXT Collections</div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="user-info">
        <div class="user-avatar">A</div>
        <div id="role"></div>
      </div>
      <button onclick="logout()" class="btn btn-danger btn-sm">Exit</button>
    </div>
  </div>

  <div class="content">
    <div id="shops"></div>
  </div>

  <!-- View Modal -->
  <div id="modal" class="modal-overlay" style="display:none">
    <div class="modal" style="max-width:800px">
      <div class="modal-header">
        <div class="modal-title" id="mtitle"></div>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div id="mimage"></div>
        <div id="mnote"></div>
        <textarea id="mcontent" class="textarea" style="min-height:400px;font-family:'JetBrains Mono';font-size:12px" readonly></textarea>
      </div>
      <div class="modal-footer">
        <button onclick="downloadContent()" class="btn btn-success">Download</button>
        <button onclick="closeModal()" class="btn btn-primary">Close</button>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    
    if (!token) location.href = '/login';
    
    document.getElementById('role').textContent = role.toUpperCase();
    if (role === 'admin') document.getElementById('sets').style.display = 'flex';

    let currentShop = null;

    async function loadShops() {
      try {
        const res = await fetch('/api/shops', {
          headers: { Authorization: token }
        });
        const shops = await res.json();

        const container = document.getElementById('shops');
        
        if (shops.length === 0) {
          container.innerHTML = `
            <div style="text-align:center;padding:60px 20px">
              <div style="font-size:48px;margin-bottom:16px">üõí</div>
              <div style="font-size:18px;font-weight:600;color:#e6edf3;margin-bottom:8px">No Shops Available</div>
              <div style="font-size:14px;color:#8b949e">Admin will upload shop collections soon</div>
            </div>
          `;
        } else {
          container.innerHTML = shops.map(s => `
            <div class="card">
              ${s.image ? `<img src="${s.image}" style="width:100%;height:200px;object-fit:cover;border-radius:8px;margin-bottom:12px">` : ''}
              <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
                <div>
                  <div style="font-size:16px;font-weight:600;color:#e6edf3;margin-bottom:4px">${s.name}</div>
                  <div style="font-size:12px;color:#8b949e">
                    <span style="font-family:'JetBrains Mono';color:#58a6ff">${s.lines.toLocaleString()}</span> lines
                    ‚Ä¢ ${new Date(s.created).toLocaleDateString()}
                  </div>
                </div>
                <button onclick="viewShop(${s.id})" class="btn btn-primary btn-sm">View</button>
              </div>
              ${s.note ? `<div style="padding:8px 12px;background:#0d1117;border-radius:6px;font-size:13px;color:#c9d1d9">${s.note}</div>` : ''}
            </div>
          `).join('');
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function viewShop(id) {
      try {
        const res = await fetch(`/api/shop/${id}`, {
          headers: { Authorization: token }
        });
        const shop = await res.json();

        currentShop = shop;
        document.getElementById('mtitle').textContent = shop.name;
        document.getElementById('mcontent').value = shop.content;
        
        if (shop.image) {
          document.getElementById('mimage').innerHTML = `<img src="${shop.image}" style="width:100%;max-height:300px;object-fit:cover;border-radius:6px;margin-bottom:12px">`;
        } else {
          document.getElementById('mimage').innerHTML = '';
        }

        if (shop.note) {
          document.getElementById('mnote').innerHTML = `<div style="padding:8px 12px;background:#0d1117;border-radius:6px;font-size:13px;color:#c9d1d9;margin-bottom:12px">${shop.note}</div>`;
        } else {
          document.getElementById('mnote').innerHTML = '';
        }

        document.getElementById('modal').style.display = 'flex';
      } catch (e) {
        alert('Error loading shop');
      }
    }

    function downloadContent() {
      if (!currentShop) return;
      
      const blob = new Blob([currentShop.content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentShop.name.replace(/[^a-z0-9]/gi, '_')}_${Date.now()}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
      currentShop = null;
    }

    function logout() {
      localStorage.clear();
      location.href = '/login';
    }

    loadShops();
  </script>
</body>
</html>
